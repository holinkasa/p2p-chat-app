name: Build Android APK

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Java JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: 3.24.0
          channel: stable
          cache: true
      
      - name: Check Flutter
        run: flutter doctor -v
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11
      
      - name: Install Flet
        run: |
          python -m pip install --upgrade pip
          pip install flet
      
      - name: Build APK
        run: |
          flet build apk --yes --verbose --project P2PChat --org com.p2pchat --product P2PSecureChat
      
      - name: List build output
        run: |
          echo "=== Build directory ==="
          find . -name "*.apk" -type f 2>/dev/null || echo "No APK found in current dir"
          ls -la build/apk/ 2>/dev/null || echo "No build/apk directory"
      
      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: P2PSecureChat-APK
          path: |
            build/apk/
            **/*.apk
          if-no-files-found: warn
          retention-days: 90
      
  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: write
    
    steps:
      - name: Download APK
        uses: actions/download-artifact@v4
        with:
          name: P2PSecureChat-APK
          path: ./release
      
      - name: List downloaded files
        run: ls -la ./release/
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v1.0.${{ github.run_number }}
          name: P2P Secure Chat v1.0.${{ github.run_number }}
          body: |
            ## P2P Secure Chat
            
            ### Download
            Download the APK file below and install on your Android device.
            
            ### Installation
            1. Download the APK
            2. Enable "Unknown Sources" in Android settings
            3. Install the APK
            4. Open and start chatting!
          files: ./release/**/*
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
